# ClaudeStep Workflow
#
# This workflow handles all event types automatically by passing the GitHub
# event context to the action. The action determines:
# - Whether to execute or skip (checks for claudestep label and merged state)
# - Which ref to checkout
# - The project name (from branch pattern or input)
# - The base branch for PR creation (from project config or default)
#
# Trigger modes:
# - workflow_dispatch: Manual trigger with project_name input
# - pull_request (closed): Continues processing after PR merge
#
# Note: Label filtering is done inside the action (not at workflow level) because
# GitHub Actions pull_request triggers don't support label filters. The action
# checks that PRs have the 'claudestep' label and were merged before processing.
#
# Security: workflow_dispatch requires repository write access.

name: ClaudeStep

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name (folder under claude-step/)'
        required: true
        type: string
        default: 'e2e-test-project'

  pull_request:
    types: [closed]
    branches:
      - main
      - main-e2e

permissions:
  contents: write       # Commit and push changes
  pull-requests: write  # Create PRs
  issues: write         # Create labels

jobs:
  run-claudestep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          github_event: ${{ toJson(github.event) }}
          event_name: ${{ github.event_name }}
          project_name: ${{ github.event.inputs.project_name || '' }}
          claude_model: 'claude-3-haiku-20240307'
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
