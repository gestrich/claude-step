# ClaudeStep workflow - Generic workflow that works on ANY branch
#
# This workflow is branch-agnostic and adapts to any branch without configuration.
#
# Trigger modes:
# - workflow_dispatch: Manual trigger with project_name input
# - pull_request close: Continues processing after PR merge (requires 'claudestep' label)
#
# Base branch inference:
# - PR merge event: Uses github.base_ref (the branch the PR was merged INTO)
# - workflow_dispatch: Uses base_branch input if provided, otherwise uses checkout_ref
#
# When a spec is pushed to 'main', PRs target 'main'.
# When a spec is pushed to 'main-e2e', PRs target 'main-e2e'.
# Works on any branch: feature branches, test branches, etc.
#
# Security considerations:
# - PR merge trigger: Only runs for PRs with 'claudestep' label (requires write access to add)
# - workflow_dispatch: Requires repository write access to trigger
# - Branch names validated against strict pattern (claude-step-{project}-{hex})
# - Spec files fetched from base branch via GitHub API (source of truth)
# - No arbitrary code execution from PR branches - only spec.md content drives tasks

name: ClaudeStep

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name (folder under claude-step/)'
        required: true
        type: string
        default: 'e2e-test-project'

  pull_request:
    types: [closed]

permissions:
  contents: write       # Commit and push changes
  pull-requests: write  # Create PRs
  issues: write         # Create labels

jobs:
  run-claudestep:
    runs-on: ubuntu-latest
    steps:
      - uses: ./
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          github_event: ${{ toJson(github.event) }}
          event_name: ${{ github.event_name }}
          project_name: ${{ github.event.inputs.project_name || '' }}
          claude_model: 'claude-3-haiku-20240307'
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
