name: ClaudeStep

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name in claude-step directory'
        required: true
      base_branch:
        description: 'Base branch for pull requests'
        required: false
        default: 'e2e-test'
      checkout_ref:
        description: 'Branch/ref to checkout (defaults to e2e-test)'
        required: false
        default: 'e2e-test'

  pull_request:
    types: [closed]

permissions:
  contents: write       # Commit and push changes
  pull-requests: write  # Create PRs
  issues: write         # Create labels

jobs:
  run-claudestep:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Determine project and checkout ref
        id: project
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Use manual inputs
            PROJECT="${{ github.event.inputs.project_name }}"
            BASE_BRANCH="${{ github.event.inputs.base_branch || 'e2e-test' }}"
            CHECKOUT_REF="${{ github.event.inputs.checkout_ref || 'e2e-test' }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # Only run for PRs with claudestep label
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'claudestep') }}" != "true" ]]; then
              echo "Skipping: PR does not have 'claudestep' label"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            # Extract from branch name: claude-step-{project}-{index}
            BRANCH="${{ github.head_ref }}"
            PROJECT=$(echo "$BRANCH" | sed -E 's/^claude-step-([^-]+)-[0-9]+$/\1/')
            # Use the base branch from the PR
            BASE_BRANCH="${{ github.base_ref }}"
            # Checkout the base branch after merge
            CHECKOUT_REF="${{ github.base_ref }}"
          fi
          echo "name=$PROJECT" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "checkout_ref=$CHECKOUT_REF" >> $GITHUB_OUTPUT
          echo "Determined project: $PROJECT, base_branch: $BASE_BRANCH, checkout_ref: $CHECKOUT_REF"

      - name: Checkout repository
        if: steps.project.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.project.outputs.checkout_ref }}

      - name: Run ClaudeStep action
        if: steps.project.outputs.skip != 'true'
        uses: ./
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          project_name: ${{ steps.project.outputs.name }}
          base_branch: ${{ steps.project.outputs.base_branch }}
          merged_pr_number: ${{ github.event.pull_request.number }}
          claude_model: 'claude-3-haiku-20240307'
          slack_webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
