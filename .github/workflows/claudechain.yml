# ClaudeChain Workflow
#
# This workflow triggers the ClaudeChain action which automatically reads
# the GitHub event context. The action determines:
# - Whether to execute or skip (based on merged state and spec.md changes)
# - Which ref to checkout
# - The project name (from changed files, branch pattern, or input)
# - The base branch for PR creation (from project config or default)
#
# Trigger modes:
# - workflow_dispatch: Manual trigger with project_name input
# - pull_request (closed): Triggers on any PR merge that changes claude-chain/** files
#
# Note: The action detects projects from changed spec.md files and skips label checking
# when spec files change. This enables automatic triggering for initial spec merges.
# For ClaudeChain-created PRs (following branch naming convention), label checking
# still applies as a fallback.
#
# Security: workflow_dispatch requires repository write access.

name: ClaudeChain

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name (folder under claude-chain/)'
        required: true
        type: string
        default: 'e2e-test-project'
      base_branch:
        description: 'Base branch where spec file lives (must match project config if set)'
        required: true
        type: string
        default: 'main'

  pull_request:
    types: [closed]
    # No branch filter - ClaudeChain validates base branch in prepare.py
    # This allows projects to use any base branch via configuration.yml baseBranch setting
    paths:
      - 'claude-chain/**'

permissions:
  contents: write       # Commit and push changes
  pull-requests: write  # Create PRs
  issues: write         # Create labels

jobs:
  run-claudechain:
    runs-on: ubuntu-latest
    steps:
      - uses: ./
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CHAIN_ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          project_name: ${{ github.event.inputs.project_name || '' }}
          default_base_branch: ${{ github.event.inputs.base_branch || '' }}
          claude_model: 'claude-3-haiku-20240307'
          slack_webhook_url: ${{ secrets.CLAUDE_CHAIN_SLACK_WEBHOOK_URL }}
