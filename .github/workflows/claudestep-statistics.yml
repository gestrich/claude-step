name: ClaudeStep Daily Statistics

# This is an example workflow showing how to use ClaudeStep Statistics with Slack
# It demonstrates:
# 1. Generating statistics using the statistics-action
# 2. Posting results to Slack using the official Slack GitHub Action
# 3. Scheduling for daily reports

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:  # Allow manual trigger for testing

permissions:
  contents: read
  actions: read

jobs:
  statistics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate ClaudeStep Statistics
        id: stats
        uses: ./statistics  # Use local action (for this repo)
        # For external repos, use: gestrich/claude-step/statistics@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          days_back: 7  # Last 7 days of activity

      - name: Post to Slack
        if: steps.stats.outputs.has_statistics == 'true'
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "ClaudeStep Weekly Report",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ClaudeStep Weekly Report"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJson(steps.stats.outputs.slack_message) }}
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Generated by <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ClaudeStep Statistics>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Example: Per-project statistics
      # Uncomment to generate stats for a specific project only
      #
      # - name: Generate Project-Specific Statistics
      #   id: project_stats
      #   uses: ./statistics
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     config_path: refactor/my-project/configuration.json
      #     days_back: 30
      #
      # - name: Post Project Stats to Slack
      #   if: steps.project_stats.outputs.has_statistics == 'true'
      #   uses: slackapi/slack-github-action@v2
      #   with:
      #     payload: |
      #       {
      #         "text": "My Project Statistics",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": ${{ toJson(steps.project_stats.outputs.slack_message) }}
      #             }
      #           }
      #         ]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.MY_PROJECT_SLACK_WEBHOOK }}
