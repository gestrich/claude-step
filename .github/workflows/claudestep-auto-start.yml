name: ClaudeStep Auto-Start

on:
  push:
    branches:
      - main
    paths:
      - 'claude-step/*/spec.md'

jobs:
  auto-start:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Detect changed spec files
        id: detect
        run: |
          # Find spec.md files that changed in this push
          CHANGED_SPECS=$(git diff --name-only HEAD^ HEAD | grep 'claude-step/.*/spec.md' || true)

          if [ -z "$CHANGED_SPECS" ]; then
            echo "No spec.md files changed"
            echo "projects=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract project names
          PROJECTS=""
          for spec_path in $CHANGED_SPECS; do
            # Extract project name from path: claude-step/<project>/spec.md
            project=$(echo "$spec_path" | sed 's|claude-step/\([^/]*\)/spec.md|\1|')
            PROJECTS="$PROJECTS $project"
          done

          echo "projects=$PROJECTS" >> $GITHUB_OUTPUT
          echo "Detected projects with spec changes: $PROJECTS"

      - name: Check if projects are new
        id: check_new
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PROJECTS="${{ steps.detect.outputs.projects }}"
          NEW_PROJECTS=""

          for project in $PROJECTS; do
            echo "Checking if project '$project' is new..."

            # Query for ClaudeStep PRs for this project
            # Note: This requires PRs to have project in branch name or label
            PR_COUNT=$(gh pr list \
              --label claudestep \
              --state all \
              --json headRefName \
              --jq "[.[] | select(.headRefName | startswith(\"claude-step-$project-\"))] | length")

            if [ "$PR_COUNT" -eq 0 ]; then
              echo "  → New project (no PRs found)"
              NEW_PROJECTS="$NEW_PROJECTS $project"
            else
              echo "  → Existing project ($PR_COUNT PRs found), skipping auto-trigger"
            fi
          done

          echo "new_projects=$NEW_PROJECTS" >> $GITHUB_OUTPUT
          echo "New projects to auto-trigger: $NEW_PROJECTS"
