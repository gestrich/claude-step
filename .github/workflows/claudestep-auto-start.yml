name: ClaudeStep Auto-Start

on:
  push:
    branches:
      - main
    paths:
      - 'claude-step/*/spec.md'

concurrency:
  group: claudestep-auto-start-${{ github.ref }}
  cancel-in-progress: false  # Let both run, they'll detect existing PRs

jobs:
  auto-start:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ClaudeStep
        run: pip install -e .

      - name: Detect and trigger auto-start
        id: auto_start
        run: python3 -m claudestep auto-start
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          BASE_BRANCH: main
          REF_BEFORE: ${{ github.event.before }}
          REF_AFTER: ${{ github.sha }}
          GH_TOKEN: ${{ github.token }}

      - name: Generate summary
        if: always()
        run: |
          echo "# ClaudeStep Auto-Start Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TRIGGERED="${{ steps.auto_start.outputs.triggered_projects }}"
          FAILED="${{ steps.auto_start.outputs.failed_projects }}"
          ALL_PROJECTS="${{ steps.auto_start.outputs.projects_to_trigger }}"

          if [ -z "$ALL_PROJECTS" ]; then
            echo "No spec.md files were changed in this push." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "## Projects with spec.md changes:" >> $GITHUB_STEP_SUMMARY
          for project in $ALL_PROJECTS; do
            echo "- $project" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$TRIGGERED" ]; then
            echo "## Auto-triggered for new projects:" >> $GITHUB_STEP_SUMMARY
            for project in $TRIGGERED; do
              echo "- ✅ $project (first task will be started)" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$FAILED" ]; then
            echo "## ⚠️ Failed to trigger:" >> $GITHUB_STEP_SUMMARY
            for project in $FAILED; do
              echo "- ❌ $project" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please manually trigger these projects or check workflow permissions." >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "$TRIGGERED" ] && [ -z "$FAILED" ]; then
            echo "No new projects detected. Existing projects rely on PR merge triggers." >> $GITHUB_STEP_SUMMARY
          fi
