# ClaudeStep

## Overview

ClaudeStep runs Claude Code on individual steps that you define for your project, creating pull requests for each step one at a time. When you merge a PR, it automatically stages the next PR, creating a chain of incremental improvements.

Built on Claude Code and GitHub Actions, it automates the tedious refactoring work that never gets prioritized -- optional migrations, refactoring, code cleanup, and documentation that would otherwise sit on the backlog forever.

## Features

- üìã **Incremental automation** - Write your refactor spec, get automated PRs for each step
- ‚ö° **Manageable review burden** - One PR at a time, distributed across team members
- üîÑ **Continuous flow** - Merge PRs when you have time, next PR stages automatically
- üí¨ **Context for reviewers** - AI-generated summaries explain each change
- üìä **Visibility** - Track progress, team stats, cost, and completion rates

## Prerequisites

- Anthropic API key ([get one here](https://console.anthropic.com))

## Setup

### Step 1: Create a Project

ClaudeStep discovers projects in the `claude-step` folder by looking for `spec.md` files.

Create this directory structure in your repo for the example project "my-refactor":

```bash
mkdir -p claude-step/my-refactor
```

Create `claude-step/my-refactor/spec.md`:

```markdown
# My Refactoring Project

Describe what you want to refactor and how to do it.

Include patterns to follow, code examples, and edge cases.

## Steps

- [ ] First step to refactor
- [ ] Second step to refactor
- [ ] Third step to refactor
```

The spec.md file combines instructions and steps. Steps use markdown checkbox syntax (`- [ ]`) and can appear anywhere in the file. When a PR is merged, the action automatically marks the step as `- [x]` and it's skipped in future runs.

That's all you need to get started! Without a configuration file, ClaudeStep uses sensible defaults:
- PRs are created without an assignee (although your CODEOWNERS may add reviewers)
- Maximum 1 open PR per project

### Step 2: Add Reviewers (Optional)

For reviewer assignment and capacity management, create `claude-step/my-refactor/configuration.yml`:

```yaml
reviewers:
  - username: YOUR_GITHUB_USERNAME
    maxOpenPRs: 1
```

This enables:
- Automatic PR assignment to configured reviewers
- Per-reviewer capacity limits (max open PRs)
- Reviewer-level statistics tracking

### Step 4: Customize PR Template (Optional)

Create `claude-step/my-refactor/pr-template.md`:

```markdown
## Step
{{TASK_DESCRIPTION}}

## Review Checklist
- [ ] Code follows conventions
- [ ] Tests pass
- [ ] No unintended changes

---
_Auto-generated by ClaudeStep_
```

Use `{{TASK_DESCRIPTION}}` to insert the step description. If no template exists, a default is used.

### Step 5: Add Workflow

Create `.github/workflows/claude-step.yml`. You have two options:

**Option A: Simplified Workflow (Recommended)**

The simplified workflow passes event context to the action, which handles all the logic internally:

```yaml
name: ClaudeStep

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name (folder under claude-step/)'
        required: true
        type: string
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  run-claudestep:
    runs-on: ubuntu-latest
    steps:
      - uses: gestrich/claude-step@v2
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          github_event: ${{ toJson(github.event) }}
          event_name: ${{ github.event_name }}
          project_name: ${{ github.event.inputs.project_name || '' }}
          # slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
```

This workflow:
- Triggers on PR close events (continues after merge) and manual dispatch
- PRs must have the `claudestep` label and be merged to trigger processing
- Automatically detects the project from ClaudeStep branch names
- Requires only ~20 lines instead of ~100

**Option B: Standard Workflow**

For more control, use the standard workflow with explicit project name:

```yaml
name: ClaudeStep

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  refactor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gestrich/claude-step@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          project_name: 'my-refactor'
          # slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
```

Note: The standard workflow triggers on both merged and closed PRs. To prevent a closed PR from reopening, mark its step as complete in spec.md first.

### Step 6: Configure GitHub

#### Add Secrets

Settings > Secrets and variables > Actions > New repository secret:
- Name: `ANTHROPIC_API_KEY`
- Value: your API key

**Optional - Slack Notifications:**
- Name: `SLACK_WEBHOOK_URL`
- Value: your Slack webhook URL from [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks)
- Uncomment the `slack_webhook_url` line in your workflow file to enable notifications

**Note:** Both PR creation notifications and statistics notifications use the same pattern - you must pass `slack_webhook_url` as an action input. Simply setting the `SLACK_WEBHOOK_URL` secret is not enough; you need to pass it to the action via the `slack_webhook_url` input parameter in your workflow file. See the [Slack Notifications](#slack-notifications) section below for details.

#### Enable PR Creation

Settings > Actions > General > Workflow permissions:
- Check "Allow GitHub Actions to create and approve pull requests"

#### Install Claude Code GitHub App

In your local repository, run in Claude Code:
```
/install-github-app
```

This grants permissions for Claude to read your spec and create pull requests.

### Step 7: Run & Test

#### Push Changes to your base branch

**Important:** ClaudeStep requires all spec files to exist in your base branch before running. This ensures a consistent source of truth for all operations.

Commit and push your configuration, spec, and workflow file to your base branch (typically "main"):

```bash
git add claude-step/my-refactor/
git add .github/workflows/claude-step.yml
git commit -m "Add ClaudeStep configuration for my-refactor"
git push origin main
```

> **Note:** ClaudeStep workflows are **branch-agnostic** and work on any branch. Push your spec to whichever branch you want PRs to target. The workflows automatically detect the base branch and create PRs targeting that same branch.

#### Starting ClaudeStep

You have two options to start ClaudeStep for a new project:

**Option 1: Add spec via PR with `claudestep` label (Recommended)**

Create a PR that adds your spec files, add the `claudestep` label to the PR, then merge it. This will automatically trigger ClaudeStep to create the first task PR.

```bash
git checkout -b add-my-refactor-spec
git add claude-step/my-refactor/
git commit -m "Add ClaudeStep project: my-refactor"
git push origin add-my-refactor-spec
# Create PR, add 'claudestep' label, then merge
```

**Option 2: Manual trigger**

If you pushed directly to main, manually trigger the first task:

1. Go to Actions > ClaudeStep > Run workflow
2. Enter your project name (e.g., `my-refactor`)
3. Wait ~2-5 minutes
4. Check for new PR

#### Automatic Continuation

After the first PR is created:
1. Review and merge the PR (it will have the `claudestep` label)
2. ClaudeStep detects the merge and automatically starts the next task
3. A new PR is created for task 2
4. The process continues until all tasks are complete

**Note:** PRs must have the `claudestep` label and be merged (not just closed) to trigger the next task.

### Step 8: Review & Iterate

Review the generated PR, verify it follows your spec, and make any needed fixes. When satisfied, merge it. The workflow will automatically create the next PR.

## Troubleshooting

### First Task: Use Manual Trigger

The first task for a new project must be manually triggered:

1. Go to Actions > ClaudeStep > Run workflow
2. Enter your project name
3. Click "Run workflow"

Subsequent tasks trigger automatically when you merge PRs with the `claudestep` label.

### PR Merge Doesn't Trigger Next Task

If merging a PR doesn't trigger the next task:

1. **Check the label**: Ensure the PR has the `claudestep` label
2. **Verify it was merged**: The PR must be merged, not just closed
3. **Check workflow run**: Go to Actions > ClaudeStep and verify a run was triggered
4. **Review the logs**: Look at the workflow logs for any error messages

## Modifying Tasks

You can freely insert, delete, and reorder tasks in your spec.md file. Each task is identified by a hash of its description, not its position.

**Important:** If you change a task description while a PR is open for that task:
1. The open PR becomes "orphaned" (references the old description)
2. ClaudeStep will detect and warn you about orphaned PRs
3. Close the orphaned PR manually
4. The workflow will automatically create a new PR with the updated task description

**Tip:** To avoid orphaned PRs, modify task descriptions only when no PR is open for that task, or be prepared to close and recreate the PR.

### Scaling Up

**PR Assignment:** PRs are assigned per reviewer. Multiple reviewers enable parallel progress, and each reviewer gets a new PR when they merge theirs.

**Scale by:**
- Increasing `maxOpenPRs` per reviewer
- Adding more reviewers to `configuration.yml`
- Creating multiple projects in `claude-step/`

## Slack Notifications

ClaudeStep can send Slack notifications for both PR creation and weekly statistics. Both use the same simple pattern: pass your webhook URL as an action input.

### Setting Up Slack Notifications

**1. Get a Slack Webhook URL:**
- Visit [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks)
- Create an incoming webhook for your Slack workspace
- Copy the webhook URL (it looks like `https://hooks.slack.com/services/...`)

**2. Add as a GitHub Secret:**
- Go to Settings > Secrets and variables > Actions > New repository secret
- Name: `SLACK_WEBHOOK_URL`
- Value: paste your webhook URL

**3. Pass to Actions:**

For **PR creation notifications**, uncomment the `slack_webhook_url` line in your ClaudeStep workflow:

```yaml
- uses: gestrich/claude-step@v1
  with:
    anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
    github_token: ${{ secrets.GITHUB_TOKEN }}
    project_name: 'my-refactor'
    slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}  # Enable PR notifications
```

For **statistics notifications**, add the ClaudeStep Statistics workflow (`.github/workflows/claudestep-statistics.yml`):

```yaml
name: ClaudeStep Statistics

on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday at 9 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  statistics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gestrich/claude-step/statistics@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          days_back: 7
          base_branch: main  # Optional: specify if using non-default branch
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}  # Enable statistics notifications
```

**What You'll Receive:**

- **PR Notifications:** Posted when a new PR is created, including the step description, assignee, and PR link
- **Statistics Reports:** Weekly summaries showing team progress, completion rates, reviewer activity, and cost tracking

**Important:** You must pass `slack_webhook_url` as an action input. Simply setting the `SLACK_WEBHOOK_URL` secret without passing it to the action will not enable notifications.

## Action Inputs & Outputs

### Inputs

| Input | Required | Default | Description |
|-------|----------|---------|-------------|
| `anthropic_api_key` | Y | - | Anthropic API key for Claude Code |
| `github_token` | Y | `${{ github.token }}` | GitHub token for PR operations |
| `project_name` | Conditional | - | Project folder name under `/claude-step`. Required unless using simplified workflow with `github_event` |
| `github_event` | N | - | GitHub event payload for simplified workflow (pass `${{ toJson(github.event) }}`) |
| `event_name` | N | - | GitHub event name for simplified workflow (pass `${{ github.event_name }}`) |
| `claude_model` | N | `claude-sonnet-4-5` | Claude model to use (e.g., claude-3-haiku-20240307, claude-sonnet-4-5, claude-opus-4-5) |
| `claude_allowed_tools` | N | `Write,Read,Bash,Edit` | Comma-separated list of tools Claude can use |
| `base_branch` | N | (inferred) | Base branch where spec files exist and PRs will target. Automatically inferred from workflow context (PR merge or checkout_ref). Spec files are fetched from this branch via GitHub API. |
| `default_base_branch` | N | `main` | Default base branch if not determined from event context (simplified workflow only) |
| `working_directory` | N | `.` | Working directory |
| `add_pr_summary` | N | `true` | Add AI-generated summary comment to PR |
| `slack_webhook_url` | N | - | Slack webhook URL for PR notifications |
| `pr_label` | N | `claudestep` | Label to apply to ClaudeStep PRs |

### Outputs

| Output | Description |
|--------|-------------|
| `skipped` | Whether execution was skipped (no claudestep label, PR not merged, etc.) |
| `skip_reason` | Reason for skipping if skipped |
| `project_name` | Detected/resolved project name |
| `base_branch` | Resolved base branch |
| `pr_number` | Number of created PR (empty if none) |
| `pr_url` | URL of created PR (empty if none) |
| `reviewer` | Assigned reviewer username |
| `step_completed` | Step description completed |
| `has_capacity` | Whether reviewer had capacity |
| `all_steps_done` | Whether all steps are complete |

### Input Details

**claude_model:** Specify which Claude model to use:
- `claude-3-haiku-20240307` - Fastest, most cost-effective ($0.25/$1.25 per MTok)
- `claude-sonnet-4-5` - Recommended, balanced performance and cost (default)
- `claude-opus-4-5` - Highest capability, higher cost

**claude_allowed_tools:** Available: `Write`, `Read`, `Bash`, `Edit`, `Glob`, `Grep`. Default: `Write,Read,Bash,Edit`

**add_pr_summary:** When `true` (default), posts an AI-generated summary comment on each PR (~$0.002-0.005 per summary)

**pr_label:** Label for ClaudeStep PRs. Default: `claude-step`. Used to identify PRs and track reviewer capacity.

**slack_webhook_url:** Optional. Webhook URL for Slack notifications when PRs are created. Get from [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks). Must be passed as an action input (not just set as an environment variable) for PR notifications to work. Add as GitHub secret named `SLACK_WEBHOOK_URL` and pass via `slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}` in your workflow.

**anthropic_api_key:** Get from [console.anthropic.com](https://console.anthropic.com). Add as GitHub secret named `ANTHROPIC_API_KEY`.

## Configuration Reference

### configuration.yml (Optional)

The configuration file is **optional**. Projects work without it using sensible defaults:
- No reviewer assignment (PRs created without assignee)
- Maximum 1 open PR per project

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reviewers` | array | | List of reviewer objects |
| `reviewers[].username` | string | Yes | GitHub username |
| `reviewers[].maxOpenPRs` | number | Yes | Maximum open PRs for this reviewer |
| `baseBranch` | string | | Override base branch for this project (defaults to workflow context) |

Example:
```yaml
reviewers:
  - username: alice
    maxOpenPRs: 1
  - username: bob
    maxOpenPRs: 2
baseBranch: develop  # Optional: override base branch for this project
```

**reviewers:** When configured, PRs are automatically assigned to reviewers based on capacity (open PRs < maxOpenPRs). Without reviewers, PRs are created without an assignee.

**baseBranch:** When specified, PRs for this project will target the specified branch instead of the workflow's default. Useful when different projects in the same repo target different branches (e.g., one project targets `main`, another targets `develop`).

**Branch Naming:** All ClaudeStep PRs use the format `claude-step-{project_name}-{task-hash}` (e.g., `claude-step-my-refactor-a3f2b891`). Each task is identified by a hash of its description, allowing you to freely reorder, insert, or delete tasks in spec.md without breaking PR tracking.

### spec.md Format

Markdown file combining instructions and steps. Steps use checkbox syntax (`- [ ]`) and can appear anywhere.

**Lifecycle:** Unchecked (`- [ ]`) ‚Üí PR created ‚Üí PR merged ‚Üí Auto-marked complete (`- [x]`) ‚Üí Skipped in future runs

## Development

**Running Unit and Integration Tests:**

```bash
# Set Python path
export PYTHONPATH=src:scripts

# Run all unit and integration tests with coverage
pytest tests/unit/ tests/integration/ -v

# Run only unit tests (fast, isolated)
pytest tests/unit/ -v

# Run only integration tests (CLI commands)
pytest tests/integration/ -v

# View coverage report
coverage report --show-missing
coverage html  # Generates htmlcov/index.html
```

**Running End-to-End Tests:**

End-to-end integration tests are now located in this repository at `tests/e2e/`. These tests validate the complete ClaudeStep workflow using a recursive pattern where the action tests itself.

```bash
cd /path/to/claude-step
./tests/e2e/run_test.sh
```

Prerequisites:
- GitHub CLI (`gh`) installed and authenticated
- Python 3.11+ with pytest
- Repository write access
- `ANTHROPIC_API_KEY` environment variable or GitHub secret

The E2E tests will:
- Create temporary test projects in `claude-step/test-*`
- Trigger the ClaudeStep workflow on itself
- Verify PRs are created with AI-generated summaries
- Test reviewer capacity limits
- Clean up all test resources automatically

See [tests/e2e/README.md](tests/e2e/README.md) for detailed documentation.

**Configuring PR Merge Requirements (Maintainers):**

To require tests to pass before merging PRs:

1. Go to **Settings** > **Branches**
2. Add or edit a branch protection rule for `main`
3. Enable **Require status checks to pass before merging**
4. Select **unit-and-integration-tests** from the list of status checks
5. Optionally enable **Require branches to be up to date before merging**

This ensures all PRs must pass the test suite (493 tests, 85% coverage minimum) before merging.

## Examples

See [`.github/workflows/claudestep.yml`](.github/workflows/claudestep.yml) for a complete reference implementation. This project uses ClaudeStep to automate its own development.

## Migrating to Simplified Workflow

If you're currently using the standard workflow and want to switch to the simplified version:

1. **Update your workflow file** to use the simplified format (see Step 3 above)
2. **Remove custom bash logic** for determining project name and base branch - the action handles this automatically
3. **Update action version** from `@v1` to `@v2`
4. **Use `pull_request: types: [closed]`** trigger for automatic continuation after PR merges
5. **Add new inputs**:
   - `github_event: ${{ toJson(github.event) }}`
   - `event_name: ${{ github.event_name }}`
6. **Make project_name conditional**: Only needed for `workflow_dispatch`, extracted from branch name for PR events

The simplified workflow automatically:
- Extracts project name from branch pattern `claude-step-{project}-{hash}`
- Checks that PRs have the `claudestep` label and were merged
- Determines the base branch from the event context

## Contributing

Contributions welcome! Open an issue to discuss changes. Add tests and update docs.

## Support & Credits

- üêõ [Report Issues](https://github.com/gestrich/claude-step/issues)
- üí¨ [Discussions](https://github.com/gestrich/claude-step/discussions)
- üìö [Planned Features](docs/TODO.md)

Created by [gestrich](https://github.com/gestrich). Built with [Claude Code](https://github.com/anthropics/claude-code-action).

MIT License - see LICENSE file
