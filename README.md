# ClaudeStep

[![Tests](https://github.com/gestrich/claude-step/actions/workflows/test.yml/badge.svg)](https://github.com/gestrich/claude-step/actions/workflows/test.yml)
[![codecov](https://codecov.io/gh/gestrich/claude-step/branch/main/graph/badge.svg)](https://codecov.io/gh/gestrich/claude-step)

## Overview

ClaudeStep runs Claude Code on individual steps that you define for your project, creating pull requests for each step one at a time. When you merge a PR, it automatically stages the next PR, creating a chain of incremental improvements.

Built on Claude Code and GitHub Actions, it automates the tedious refactoring work that never gets prioritized -- optional migrations, refactoring, code cleanup, and documentation that would otherwise sit on the backlog forever.

## Features

- ğŸ“‹ **Incremental automation** - Write your refactor spec, get automated PRs for each step
- âš¡ **Manageable review burden** - One PR at a time, distributed across team members
- ğŸ”„ **Continuous flow** - Merge PRs when you have time, next PR stages automatically
- ğŸ’¬ **Context for reviewers** - AI-generated summaries explain each change
- ğŸ“Š **Visibility** - Track progress, team stats, cost, and completion rates

## Prerequisites

- GitHub repository with code to refactor
- Anthropic API key ([get one here](https://console.anthropic.com))

## Setup

### Step 1: Create a Project

ClaudeStep relies on projects in the `claude-step` folder to source where to find its projects and configuration.

Create this directory structure in your repo fro the example project "my-refactor":

```bash
mkdir -p claude-step/my-refactor
```

Create `claude-step/my-refactor/configuration.yml`:

```yaml
reviewers:
  - username: YOUR_GITHUB_USERNAME
    maxOpenPRs: 1
```

Create `claude-step/my-refactor/spec.md`:

```markdown
# My Refactoring Project

Describe what you want to refactor and how to do it.

Include patterns to follow, code examples, and edge cases.

## Steps

- [ ] First step to refactor
- [ ] Second step to refactor
- [ ] Third step to refactor
```

The spec.md file combines instructions and steps. Steps use markdown checkbox syntax (`- [ ]`) and can appear anywhere in the file. When a PR is merged, the action automatically marks the step as `- [x]` and it's skipped in future runs.

### Step 2: Customize PR Template (Optional)

Create `claude-step/my-refactor/pr-template.md`:

```markdown
## Step
{{TASK_DESCRIPTION}}

## Review Checklist
- [ ] Code follows conventions
- [ ] Tests pass
- [ ] No unintended changes

---
_Auto-generated by ClaudeStep_
```

Use `{{TASK_DESCRIPTION}}` to insert the step description. If no template exists, a default is used.

### Step 3: Add Workflow

Create `.github/workflows/claude-step.yml`:

```yaml
name: ClaudeStep

on:
  pull_request:
    types: [closed]    # Triggers on merge or close
  workflow_dispatch:   # Manual trigger

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  refactor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gestrich/claude-step@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          project_name: 'my-refactor'
          # slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}  # Uncomment if you set SLACK_WEBHOOK_URL in GitHub secrets
```

Note: Triggers on both merged and closed PRs. To prevent a closed PR from reopening, mark its step as complete in spec.md first.

### Step 4: Configure GitHub

#### Add Secrets

Settings > Secrets and variables > Actions > New repository secret:
- Name: `ANTHROPIC_API_KEY`
- Value: your API key

**Optional - Slack Notifications:**
- Name: `SLACK_WEBHOOK_URL`
- Value: your Slack webhook URL from [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks)
- Uncomment the `slack_webhook_url` line in your workflow file to enable PR creation notifications

**Note:** The `slack_webhook_url` input is required for PR creation notifications. If you only have the `SLACK_WEBHOOK_URL` secret set without passing it as an action input, you will not receive PR notifications (though weekly statistics notifications will still work if you have the statistics workflow configured).

#### Enable PR Creation

Settings > Actions > General > Workflow permissions:
- Check "Allow GitHub Actions to create and approve pull requests"

#### Install Claude Code GitHub App

In your local repository, run in Claude Code:
```
/install-github-app
```

This grants permissions for Claude to read your spec and create pull requests.

### Step 5: Run & Test

#### Push Changes to your base branch

Commit and push your configuration, spec, and workflow file to your base branch, often named "main" 

#### Trigger Initial Workflow

1. Go to Actions > ClaudeStep > Run workflow
2. Wait ~2-5 minutes
3. Check for new PR

Future PRs will trigger automatically on merge.

### Step 6: Review & Iterate

Review the generated PR, verify it follows your spec, and make any needed fixes. When satisfied, merge it. The workflow will automatically create the next PR.

### Scaling Up

**PR Assignment:** PRs are assigned per reviewer. Multiple reviewers enable parallel progress, and each reviewer gets a new PR when they merge theirs.

**Scale by:**
- Increasing `maxOpenPRs` per reviewer
- Adding more reviewers to `configuration.yml`
- Creating multiple projects in `claude-step/`

## Action Inputs & Outputs

### Inputs

| Input | Required | Default | Description |
|-------|----------|---------|-------------|
| `anthropic_api_key` | Y | - | Anthropic API key for Claude Code |
| `github_token` | Y | `${{ github.token }}` | GitHub token for PR operations |
| `project_name` | Y | - | Project folder name under `/claude-step` |
| `claude_model` | N | `claude-sonnet-4-5` | Claude model to use (e.g., claude-3-haiku-20240307, claude-sonnet-4-5, claude-opus-4-5) |
| `claude_allowed_tools` | N | `Write,Read,Bash,Edit` | Comma-separated list of tools Claude can use |
| `base_branch` | N | `main` | Base branch for PRs |
| `working_directory` | N | `.` | Working directory |
| `add_pr_summary` | N | `true` | Add AI-generated summary comment to PR |
| `slack_webhook_url` | N | - | Slack webhook URL for PR notifications |
| `pr_label` | N | `claude-step` | Label to apply to ClaudeStep PRs |

### Outputs

| Output | Description |
|--------|-------------|
| `pr_number` | Number of created PR (empty if none) |
| `pr_url` | URL of created PR (empty if none) |
| `reviewer` | Assigned reviewer username |
| `step_completed` | Step description completed |
| `has_capacity` | Whether reviewer had capacity |
| `all_steps_done` | Whether all steps are complete |

### Input Details

**claude_model:** Specify which Claude model to use:
- `claude-3-haiku-20240307` - Fastest, most cost-effective ($0.25/$1.25 per MTok)
- `claude-sonnet-4-5` - Recommended, balanced performance and cost (default)
- `claude-opus-4-5` - Highest capability, higher cost

**claude_allowed_tools:** Available: `Write`, `Read`, `Bash`, `Edit`, `Glob`, `Grep`. Default: `Write,Read,Bash,Edit`

**add_pr_summary:** When `true` (default), posts an AI-generated summary comment on each PR (~$0.002-0.005 per summary)

**pr_label:** Label for ClaudeStep PRs. Default: `claude-step`. Used to identify PRs and track reviewer capacity.

**slack_webhook_url:** Optional. Webhook URL for Slack notifications when PRs are created. Get from [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks). Must be passed as an action input (not just set as an environment variable) for PR notifications to work. Add as GitHub secret named `SLACK_WEBHOOK_URL` and pass via `slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}` in your workflow.

**anthropic_api_key:** Get from [console.anthropic.com](https://console.anthropic.com). Add as GitHub secret named `ANTHROPIC_API_KEY`.

## Configuration Reference

### configuration.yml

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reviewers` | array | âœ… | Reviewers with `username` and `maxOpenPRs` |

Example:
```yaml
reviewers:
  - username: alice
    maxOpenPRs: 1
  - username: bob
    maxOpenPRs: 2
```

**Branch Naming:** All ClaudeStep PRs use the format `claude-step-{project_name}-{index}` (e.g., `claude-step-my-refactor-1`).

### spec.md Format

Markdown file combining instructions and steps. Steps use checkbox syntax (`- [ ]`) and can appear anywhere.

**Lifecycle:** Unchecked (`- [ ]`) â†’ PR created â†’ PR merged â†’ Auto-marked complete (`- [x]`) â†’ Skipped in future runs

## Development

**Running Unit Tests:**

```bash
# Set Python path
export PYTHONPATH=src:scripts

# Run tests with coverage
pytest tests/unit/ -v

# View coverage report
coverage report --show-missing
coverage html  # Generates htmlcov/index.html
```

**Running End-to-End Tests:**

End-to-end integration tests are now located in this repository at `tests/e2e/`. These tests validate the complete ClaudeStep workflow using a recursive pattern where the action tests itself.

```bash
cd /path/to/claude-step
./tests/e2e/run_test.sh
```

Prerequisites:
- GitHub CLI (`gh`) installed and authenticated
- Python 3.11+ with pytest
- Repository write access
- `ANTHROPIC_API_KEY` environment variable or GitHub secret

The E2E tests will:
- Create temporary test projects in `claude-step/test-*`
- Trigger the ClaudeStep workflow on itself
- Verify PRs are created with AI-generated summaries
- Test reviewer capacity limits
- Clean up all test resources automatically

See [tests/e2e/README.md](tests/e2e/README.md) for detailed documentation.

**Configuring PR Merge Requirements (Maintainers):**

To require tests to pass before merging PRs:

1. Go to **Settings** > **Branches**
2. Add or edit a branch protection rule for `main`
3. Enable **Require status checks to pass before merging**
4. Select **test** from the list of status checks
5. Optionally enable **Require branches to be up to date before merging**

This ensures all PRs must pass the test suite (493 tests, 85% coverage minimum) before merging.

## Examples

- [Basic Example](examples/basic/workflow.yml) - Single project, scheduled trigger
- [Advanced Example](examples/advanced/workflow.yml) - Multi-project with all triggers

## Contributing

Contributions welcome! Open an issue to discuss changes. Add tests and update docs.

## Support & Credits

- ğŸ› [Report Issues](https://github.com/gestrich/claude-step/issues)
- ğŸ’¬ [Discussions](https://github.com/gestrich/claude-step/discussions)
- ğŸ“š [Planned Features](docs/TODO.md)

Created by [gestrich](https://github.com/gestrich). Built with [Claude Code](https://github.com/anthropics/claude-code-action).

MIT License - see LICENSE file
