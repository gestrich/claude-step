# ClaudeStep

## Overview

ClaudeStep runs Claude Code on individual steps that you define for your project, creating pull requests for each step one at a time. When you merge a PR, it automatically stages the next PR, creating a chain of incremental improvements.

Built on Claude Code and GitHub Actions, it automates the tedious refactoring work that never gets prioritized -- optional migrations, refactoring, code cleanup, and documentation that would otherwise sit on the backlog forever.

## Features

- üìã **Incremental automation** - Write your refactor spec, get automated PRs for each step
- ‚ö° **Manageable review burden** - One PR at a time, distributed across team members
- üîÑ **Continuous flow** - Merge PRs when you have time, next PR stages automatically
- üí¨ **Context for reviewers** - AI-generated summaries explain each change
- üìä **Visibility** - Track progress, team stats, cost, and completion rates

## Prerequisites

- GitHub repository with code to refactor
- Anthropic API key ([get one here](https://console.anthropic.com))

## Setup

### Step 1: Create a Project

ClaudeStep relies on projects in the `claude-step` folder to source where to find its projects and configuration.

Create this directory structure in your repo fro the example project "my-refactor":

```bash
mkdir -p claude-step/my-refactor
```

Create `claude-step/my-refactor/configuration.yml`:

```yaml
reviewers:
  - username: YOUR_GITHUB_USERNAME
    maxOpenPRs: 1
```

Create `claude-step/my-refactor/spec.md`:

```markdown
# My Refactoring Project

Describe what you want to refactor and how to do it.

Include patterns to follow, code examples, and edge cases.

## Steps

- [ ] First step to refactor
- [ ] Second step to refactor
- [ ] Third step to refactor
```

The spec.md file combines instructions and steps. Steps use markdown checkbox syntax (`- [ ]`) and can appear anywhere in the file. When a PR is merged, the action automatically marks the step as `- [x]` and it's skipped in future runs.

### Step 2: Customize PR Template (Optional)

Create `claude-step/my-refactor/pr-template.md`:

```markdown
## Step
{{TASK_DESCRIPTION}}

## Review Checklist
- [ ] Code follows conventions
- [ ] Tests pass
- [ ] No unintended changes

---
_Auto-generated by ClaudeStep_
```

Use `{{TASK_DESCRIPTION}}` to insert the step description. If no template exists, a default is used.

### Step 3: Add Workflow

Create `.github/workflows/claude-step.yml`:

```yaml
name: ClaudeStep

on:
  pull_request:
    types: [closed]    # Triggers on merge or close
  workflow_dispatch:   # Manual trigger

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  refactor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gestrich/claude-step@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          project_name: 'my-refactor'
          # slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}  # Uncomment if you set SLACK_WEBHOOK_URL in GitHub secrets
```

Note: Triggers on both merged and closed PRs. To prevent a closed PR from reopening, mark its step as complete in spec.md first.

### Step 4: Configure GitHub

#### Add Secrets

Settings > Secrets and variables > Actions > New repository secret:
- Name: `ANTHROPIC_API_KEY`
- Value: your API key

**Optional - Slack Notifications:**
- Name: `SLACK_WEBHOOK_URL`
- Value: your Slack webhook URL from [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks)
- Uncomment `slack_webhook_url` in your workflow file to enable

#### Enable PR Creation

Settings > Actions > General > Workflow permissions:
- Check "Allow GitHub Actions to create and approve pull requests"

#### Install Claude Code GitHub App

In your local repository, run in Claude Code:
```
/install-github-app
```

This grants permissions for Claude to read your spec and create pull requests.

### Step 5: Run & Test

#### Push Changes to your base branch

Commit and push your configuration, spec, and workflow file to your base branch, often named "main" 

#### Trigger Initial Workflow

1. Go to Actions > ClaudeStep > Run workflow
2. Wait ~2-5 minutes
3. Check for new PR

Future PRs will trigger automatically on merge.

### Step 6: Review & Iterate

Review the generated PR, verify it follows your spec, and make any needed fixes. When satisfied, merge it. The workflow will automatically create the next PR.

### Scaling Up

**PR Assignment:** PRs are assigned per reviewer. Multiple reviewers enable parallel progress, and each reviewer gets a new PR when they merge theirs.

**Scale by:**
- Increasing `maxOpenPRs` per reviewer
- Adding more reviewers to `configuration.yml`
- Creating multiple projects in `claude-step/`

## Action Inputs & Outputs

### Inputs

| Input | Required | Default | Description |
|-------|----------|---------|-------------|
| `anthropic_api_key` | Y | - | Anthropic API key for Claude Code |
| `github_token` | Y | `${{ github.token }}` | GitHub token for PR operations |
| `project_name` | Y | - | Project folder name under `/claude-step` |
| `claude_model` | N | `claude-sonnet-4-5` | Claude model to use (sonnet-4-5 or opus-4-5) |
| `claude_allowed_tools` | N | `Write,Read,Bash,Edit` | Comma-separated list of tools Claude can use |
| `base_branch` | N | `main` | Base branch for PRs |
| `working_directory` | N | `.` | Working directory |
| `add_pr_summary` | N | `true` | Add AI-generated summary comment to PR |
| `slack_webhook_url` | N | - | Slack webhook URL for PR notifications |
| `pr_label` | N | `claude-step` | Label to apply to ClaudeStep PRs |

### Outputs

| Output | Description |
|--------|-------------|
| `pr_number` | Number of created PR (empty if none) |
| `pr_url` | URL of created PR (empty if none) |
| `reviewer` | Assigned reviewer username |
| `step_completed` | Step description completed |
| `has_capacity` | Whether reviewer had capacity |
| `all_steps_done` | Whether all steps are complete |

### Input Details

**claude_model:** `claude-sonnet-4-5` (recommended, balanced) or `claude-opus-4-5` (highest capability, higher cost)

**claude_allowed_tools:** Available: `Write`, `Read`, `Bash`, `Edit`, `Glob`, `Grep`. Default: `Write,Read,Bash,Edit`

**add_pr_summary:** When `true` (default), posts an AI-generated summary comment on each PR (~$0.002-0.005 per summary)

**pr_label:** Label for ClaudeStep PRs. Default: `claude-step`. Used to identify PRs and track reviewer capacity.

**anthropic_api_key:** Get from [console.anthropic.com](https://console.anthropic.com). Add as GitHub secret named `ANTHROPIC_API_KEY`.

## Configuration Reference

### configuration.yml

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reviewers` | array | ‚úÖ | Reviewers with `username` and `maxOpenPRs` |

Example:
```yaml
reviewers:
  - username: alice
    maxOpenPRs: 1
  - username: bob
    maxOpenPRs: 2
```

**Branch Naming:** All ClaudeStep PRs use the format `claude-step-{project_name}-{index}` (e.g., `claude-step-my-refactor-1`).

### spec.md Format

Markdown file combining instructions and steps. Steps use checkbox syntax (`- [ ]`) and can appear anywhere.

**Lifecycle:** Unchecked (`- [ ]`) ‚Üí PR created ‚Üí PR merged ‚Üí Auto-marked complete (`- [x]`) ‚Üí Skipped in future runs

## Development

**Running Integration Tests:**

Integration tests are located in the [demo repository](https://github.com/gestrich/claude-step-demo) at `/tests/integration/`.

```bash
cd /path/to/claude-step-demo
./tests/integration/run_test.sh
```

Prerequisites: GitHub CLI, Python 3.11+, pytest. See [claude-step-demo/tests/integration/README.md](https://github.com/gestrich/claude-step-demo/blob/main/tests/integration/README.md) for details.

## Examples

- [Basic Example](examples/basic/workflow.yml) - Single project, scheduled trigger
- [Advanced Example](examples/advanced/workflow.yml) - Multi-project with all triggers

## Contributing

Contributions welcome! Open an issue to discuss changes. Add tests and update docs.

## Support & Credits

- üêõ [Report Issues](https://github.com/gestrich/claude-step/issues)
- üí¨ [Discussions](https://github.com/gestrich/claude-step/discussions)
- üìö [Planned Features](docs/TODO.md)

Created by [gestrich](https://github.com/gestrich). Built with [Claude Code](https://github.com/anthropics/claude-code-action).

MIT License - see LICENSE file
