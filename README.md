# ClaudeStep

[![Tests](https://github.com/gestrich/claude-step/actions/workflows/test.yml/badge.svg)](https://github.com/gestrich/claude-step/actions/workflows/test.yml)
[![codecov](https://codecov.io/gh/gestrich/claude-step/branch/main/graph/badge.svg)](https://codecov.io/gh/gestrich/claude-step)

## Overview

ClaudeStep runs Claude Code on individual steps that you define for your project, creating pull requests for each step one at a time. When you merge a PR, it automatically stages the next PR, creating a chain of incremental improvements.

Built on Claude Code and GitHub Actions, it automates the tedious refactoring work that never gets prioritized -- optional migrations, refactoring, code cleanup, and documentation that would otherwise sit on the backlog forever.

## Features

- üìã **Incremental automation** - Write your refactor spec, get automated PRs for each step
- ‚ö° **Manageable review burden** - One PR at a time, distributed across team members
- üîÑ **Continuous flow** - Merge PRs when you have time, next PR stages automatically
- üí¨ **Context for reviewers** - AI-generated summaries explain each change
- üìä **Visibility** - Track progress, team stats, cost, and completion rates

## Prerequisites

- GitHub repository with code to refactor
- Anthropic API key ([get one here](https://console.anthropic.com))

## Setup

### Step 1: Create a Project

ClaudeStep relies on projects in the `claude-step` folder to source where to find its projects and configuration.

Create this directory structure in your repo fro the example project "my-refactor":

```bash
mkdir -p claude-step/my-refactor
```

Create `claude-step/my-refactor/configuration.yml`:

```yaml
reviewers:
  - username: YOUR_GITHUB_USERNAME
    maxOpenPRs: 1
```

Create `claude-step/my-refactor/spec.md`:

```markdown
# My Refactoring Project

Describe what you want to refactor and how to do it.

Include patterns to follow, code examples, and edge cases.

## Steps

- [ ] First step to refactor
- [ ] Second step to refactor
- [ ] Third step to refactor
```

The spec.md file combines instructions and steps. Steps use markdown checkbox syntax (`- [ ]`) and can appear anywhere in the file. When a PR is merged, the action automatically marks the step as `- [x]` and it's skipped in future runs.

### Step 2: Customize PR Template (Optional)

Create `claude-step/my-refactor/pr-template.md`:

```markdown
## Step
{{TASK_DESCRIPTION}}

## Review Checklist
- [ ] Code follows conventions
- [ ] Tests pass
- [ ] No unintended changes

---
_Auto-generated by ClaudeStep_
```

Use `{{TASK_DESCRIPTION}}` to insert the step description. If no template exists, a default is used.

### Step 3: Add Workflow

Create `.github/workflows/claude-step.yml`. You have two options:

**Option A: Simplified Workflow (Recommended)**

The simplified workflow passes event context to the action, which handles all the logic internally:

```yaml
name: ClaudeStep

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name (folder under claude-step/)'
        required: true
        type: string
  pull_request:
    types: [closed]
  push:
    paths:
      - 'claude-step/*/spec.md'

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  run-claudestep:
    runs-on: ubuntu-latest
    steps:
      - uses: gestrich/claude-step@v2
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          github_event: ${{ toJson(github.event) }}
          event_name: ${{ github.event_name }}
          project_name: ${{ github.event.inputs.project_name || '' }}
          # slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
```

This workflow:
- Automatically detects the project from branch names (for merged PRs)
- Handles all event types (workflow_dispatch, pull_request, push)
- Skips non-ClaudeStep PRs automatically
- Requires only ~20 lines instead of ~100

**Option B: Standard Workflow**

For more control, use the standard workflow with explicit project name:

```yaml
name: ClaudeStep

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  refactor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gestrich/claude-step@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          project_name: 'my-refactor'
          # slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
```

Note: The standard workflow triggers on both merged and closed PRs. To prevent a closed PR from reopening, mark its step as complete in spec.md first.

### Step 4: Configure GitHub

#### Add Secrets

Settings > Secrets and variables > Actions > New repository secret:
- Name: `ANTHROPIC_API_KEY`
- Value: your API key

**Optional - Slack Notifications:**
- Name: `SLACK_WEBHOOK_URL`
- Value: your Slack webhook URL from [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks)
- Uncomment the `slack_webhook_url` line in your workflow file to enable notifications

**Note:** Both PR creation notifications and statistics notifications use the same pattern - you must pass `slack_webhook_url` as an action input. Simply setting the `SLACK_WEBHOOK_URL` secret is not enough; you need to pass it to the action via the `slack_webhook_url` input parameter in your workflow file. See the [Slack Notifications](#slack-notifications) section below for details.

#### Enable PR Creation

Settings > Actions > General > Workflow permissions:
- Check "Allow GitHub Actions to create and approve pull requests"

#### Install Claude Code GitHub App

In your local repository, run in Claude Code:
```
/install-github-app
```

This grants permissions for Claude to read your spec and create pull requests.

### Step 5: Run & Test

#### Push Changes to your base branch

**Important:** ClaudeStep requires all spec files to exist in your base branch before running. This ensures a consistent source of truth for all operations.

Commit and push your configuration, spec, and workflow file to your base branch (typically "main"):

```bash
git add claude-step/my-refactor/
git add .github/workflows/claude-step.yml
git commit -m "Add ClaudeStep configuration for my-refactor"
git push origin main
```

**That's it!** The first task will automatically start within a few minutes.

> **Note:** ClaudeStep workflows are **branch-agnostic** and work on any branch. Push your spec to whichever branch you want PRs to target. The workflows automatically detect the base branch from the push event and create PRs targeting that same branch.

#### Auto-Start Feature

When you push a new `spec.md` file to any branch, ClaudeStep automatically detects it and starts the first task for you. No manual triggering needed!

**What happens automatically:**
1. You push your spec to a branch (e.g., `main` or `main-e2e`)
2. ClaudeStep detects the new project (no existing PRs)
3. The first task automatically starts
4. A PR is created for task 1 (targeting the same branch where you pushed the spec)
5. When you merge that PR, task 2 automatically starts
6. The process continues until all tasks are complete

**Note:** Auto-trigger only happens for new projects (no existing PRs). For existing projects, tasks trigger when the previous PR merges.

#### Manual Triggering (Optional)

If you prefer to manually trigger the first task, or if auto-start didn't work:

1. Go to Actions > ClaudeStep > Run workflow
2. Wait ~2-5 minutes
3. Check for new PR

Future PRs will trigger automatically on merge.

### Step 6: Review & Iterate

Review the generated PR, verify it follows your spec, and make any needed fixes. When satisfied, merge it. The workflow will automatically create the next PR.

## Troubleshooting

### First Task Doesn't Auto-Start

If the first task doesn't automatically start after pushing your spec:

1. **Check the workflow run**: Go to Actions > ClaudeStep Auto-Start and verify it ran
2. **Review the summary**: The workflow provides a summary showing which projects were detected and whether they were triggered
3. **Verify it's a new project**: Auto-start only works for projects with no existing ClaudeStep PRs
4. **Check for errors**: Look at the workflow logs for any error messages
5. **Manual trigger**: As a fallback, you can always manually trigger via Actions > ClaudeStep > Run workflow

### Disable Auto-Start

The auto-start feature is enabled by default for all new projects. If you prefer manual control, you can:

1. Delete or disable the `.github/workflows/claudestep-auto-start.yml` workflow file
2. Manually trigger tasks using Actions > ClaudeStep > Run workflow

Note: Disabling auto-start only affects the first task. Subsequent tasks will still auto-trigger when you merge PRs.

## Modifying Tasks

You can freely insert, delete, and reorder tasks in your spec.md file. Each task is identified by a hash of its description, not its position.

**Important:** If you change a task description while a PR is open for that task:
1. The open PR becomes "orphaned" (references the old description)
2. ClaudeStep will detect and warn you about orphaned PRs
3. Close the orphaned PR manually
4. The workflow will automatically create a new PR with the updated task description

**Tip:** To avoid orphaned PRs, modify task descriptions only when no PR is open for that task, or be prepared to close and recreate the PR.

### Scaling Up

**PR Assignment:** PRs are assigned per reviewer. Multiple reviewers enable parallel progress, and each reviewer gets a new PR when they merge theirs.

**Scale by:**
- Increasing `maxOpenPRs` per reviewer
- Adding more reviewers to `configuration.yml`
- Creating multiple projects in `claude-step/`

## Slack Notifications

ClaudeStep can send Slack notifications for both PR creation and weekly statistics. Both use the same simple pattern: pass your webhook URL as an action input.

### Setting Up Slack Notifications

**1. Get a Slack Webhook URL:**
- Visit [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks)
- Create an incoming webhook for your Slack workspace
- Copy the webhook URL (it looks like `https://hooks.slack.com/services/...`)

**2. Add as a GitHub Secret:**
- Go to Settings > Secrets and variables > Actions > New repository secret
- Name: `SLACK_WEBHOOK_URL`
- Value: paste your webhook URL

**3. Pass to Actions:**

For **PR creation notifications**, uncomment the `slack_webhook_url` line in your ClaudeStep workflow:

```yaml
- uses: gestrich/claude-step@v1
  with:
    anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
    github_token: ${{ secrets.GITHUB_TOKEN }}
    project_name: 'my-refactor'
    slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}  # Enable PR notifications
```

For **statistics notifications**, add the ClaudeStep Statistics workflow (`.github/workflows/claudestep-statistics.yml`):

```yaml
name: ClaudeStep Statistics

on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday at 9 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  statistics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gestrich/claude-step/statistics@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          days_back: 7
          base_branch: main  # Optional: specify if using non-default branch
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}  # Enable statistics notifications
```

**What You'll Receive:**

- **PR Notifications:** Posted when a new PR is created, including the step description, assignee, and PR link
- **Statistics Reports:** Weekly summaries showing team progress, completion rates, reviewer activity, and cost tracking

**Important:** You must pass `slack_webhook_url` as an action input. Simply setting the `SLACK_WEBHOOK_URL` secret without passing it to the action will not enable notifications.

## Action Inputs & Outputs

### Inputs

| Input | Required | Default | Description |
|-------|----------|---------|-------------|
| `anthropic_api_key` | Y | - | Anthropic API key for Claude Code |
| `github_token` | Y | `${{ github.token }}` | GitHub token for PR operations |
| `project_name` | Conditional | - | Project folder name under `/claude-step`. Required unless using simplified workflow with `github_event` |
| `github_event` | N | - | GitHub event payload for simplified workflow (pass `${{ toJson(github.event) }}`) |
| `event_name` | N | - | GitHub event name for simplified workflow (pass `${{ github.event_name }}`) |
| `claude_model` | N | `claude-sonnet-4-5` | Claude model to use (e.g., claude-3-haiku-20240307, claude-sonnet-4-5, claude-opus-4-5) |
| `claude_allowed_tools` | N | `Write,Read,Bash,Edit` | Comma-separated list of tools Claude can use |
| `base_branch` | N | (inferred) | Base branch where spec files exist and PRs will target. Automatically inferred from workflow context (PR merge or checkout_ref). Spec files are fetched from this branch via GitHub API. |
| `default_base_branch` | N | `main` | Default base branch if not determined from event context (simplified workflow only) |
| `working_directory` | N | `.` | Working directory |
| `add_pr_summary` | N | `true` | Add AI-generated summary comment to PR |
| `slack_webhook_url` | N | - | Slack webhook URL for PR notifications |
| `pr_label` | N | `claudestep` | Label to apply to ClaudeStep PRs |

### Outputs

| Output | Description |
|--------|-------------|
| `skipped` | Whether execution was skipped (no claudestep label, PR not merged, etc.) |
| `skip_reason` | Reason for skipping if skipped |
| `project_name` | Detected/resolved project name |
| `base_branch` | Resolved base branch |
| `pr_number` | Number of created PR (empty if none) |
| `pr_url` | URL of created PR (empty if none) |
| `reviewer` | Assigned reviewer username |
| `step_completed` | Step description completed |
| `has_capacity` | Whether reviewer had capacity |
| `all_steps_done` | Whether all steps are complete |

### Input Details

**claude_model:** Specify which Claude model to use:
- `claude-3-haiku-20240307` - Fastest, most cost-effective ($0.25/$1.25 per MTok)
- `claude-sonnet-4-5` - Recommended, balanced performance and cost (default)
- `claude-opus-4-5` - Highest capability, higher cost

**claude_allowed_tools:** Available: `Write`, `Read`, `Bash`, `Edit`, `Glob`, `Grep`. Default: `Write,Read,Bash,Edit`

**add_pr_summary:** When `true` (default), posts an AI-generated summary comment on each PR (~$0.002-0.005 per summary)

**pr_label:** Label for ClaudeStep PRs. Default: `claude-step`. Used to identify PRs and track reviewer capacity.

**slack_webhook_url:** Optional. Webhook URL for Slack notifications when PRs are created. Get from [api.slack.com/messaging/webhooks](https://api.slack.com/messaging/webhooks). Must be passed as an action input (not just set as an environment variable) for PR notifications to work. Add as GitHub secret named `SLACK_WEBHOOK_URL` and pass via `slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}` in your workflow.

**anthropic_api_key:** Get from [console.anthropic.com](https://console.anthropic.com). Add as GitHub secret named `ANTHROPIC_API_KEY`.

## Configuration Reference

### configuration.yml

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reviewers` | array | ‚úÖ | Reviewers with `username` and `maxOpenPRs` |

Example:
```yaml
reviewers:
  - username: alice
    maxOpenPRs: 1
  - username: bob
    maxOpenPRs: 2
```

**Branch Naming:** All ClaudeStep PRs use the format `claude-step-{project_name}-{task-hash}` (e.g., `claude-step-my-refactor-a3f2b891`). Each task is identified by a hash of its description, allowing you to freely reorder, insert, or delete tasks in spec.md without breaking PR tracking.

### spec.md Format

Markdown file combining instructions and steps. Steps use checkbox syntax (`- [ ]`) and can appear anywhere.

**Lifecycle:** Unchecked (`- [ ]`) ‚Üí PR created ‚Üí PR merged ‚Üí Auto-marked complete (`- [x]`) ‚Üí Skipped in future runs

## Development

**Running Unit and Integration Tests:**

```bash
# Set Python path
export PYTHONPATH=src:scripts

# Run all unit and integration tests with coverage
pytest tests/unit/ tests/integration/ -v

# Run only unit tests (fast, isolated)
pytest tests/unit/ -v

# Run only integration tests (CLI commands)
pytest tests/integration/ -v

# View coverage report
coverage report --show-missing
coverage html  # Generates htmlcov/index.html
```

**Running End-to-End Tests:**

End-to-end integration tests are now located in this repository at `tests/e2e/`. These tests validate the complete ClaudeStep workflow using a recursive pattern where the action tests itself.

```bash
cd /path/to/claude-step
./tests/e2e/run_test.sh
```

Prerequisites:
- GitHub CLI (`gh`) installed and authenticated
- Python 3.11+ with pytest
- Repository write access
- `ANTHROPIC_API_KEY` environment variable or GitHub secret

The E2E tests will:
- Create temporary test projects in `claude-step/test-*`
- Trigger the ClaudeStep workflow on itself
- Verify PRs are created with AI-generated summaries
- Test reviewer capacity limits
- Clean up all test resources automatically

See [tests/e2e/README.md](tests/e2e/README.md) for detailed documentation.

**Configuring PR Merge Requirements (Maintainers):**

To require tests to pass before merging PRs:

1. Go to **Settings** > **Branches**
2. Add or edit a branch protection rule for `main`
3. Enable **Require status checks to pass before merging**
4. Select **unit-and-integration-tests** from the list of status checks
5. Optionally enable **Require branches to be up to date before merging**

This ensures all PRs must pass the test suite (493 tests, 85% coverage minimum) before merging.

## Examples

- [Simplified Workflow](examples/claudestep-simplified.yml) - Recommended, handles all events automatically
- [Basic Example](examples/basic/workflow.yml) - Single project, scheduled trigger
- [Advanced Example](examples/advanced/workflow.yml) - Multi-project with all triggers

## Migrating to Simplified Workflow

If you're currently using the standard workflow and want to switch to the simplified version:

1. **Update your workflow file** to use the simplified format (see Step 3 above)
2. **Remove custom bash logic** for determining project name and base branch - the action handles this automatically
3. **Update action version** from `@v1` to `@v2`
4. **Add new inputs**:
   - `github_event: ${{ toJson(github.event) }}`
   - `event_name: ${{ github.event_name }}`
5. **Make project_name conditional**: Only needed for `workflow_dispatch`, extracted from branch for `pull_request`

The simplified workflow automatically:
- Skips PRs without the `claudestep` label
- Skips closed (not merged) PRs
- Extracts project name from branch pattern `claude-step-{project}-{hash}`
- Determines the base branch from the event context

## Contributing

Contributions welcome! Open an issue to discuss changes. Add tests and update docs.

## Support & Credits

- üêõ [Report Issues](https://github.com/gestrich/claude-step/issues)
- üí¨ [Discussions](https://github.com/gestrich/claude-step/discussions)
- üìö [Planned Features](docs/TODO.md)

Created by [gestrich](https://github.com/gestrich). Built with [Claude Code](https://github.com/anthropics/claude-code-action).

MIT License - see LICENSE file
