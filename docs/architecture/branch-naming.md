# Branch Naming Convention

## Overview

ClaudeStep uses a standardized branch naming convention that identifies pull requests by project and task hash, enabling stable task tracking regardless of task position in the spec file.

## Branch Format

All ClaudeStep branches follow this format:

```
claude-step-{project_name}-{task_hash}
```

**Components:**
- `claude-step`: Fixed prefix identifying ClaudeStep PRs
- `{project_name}`: Name of the project folder (e.g., "my-refactor", "auth-migration")
- `{task_hash}`: 8-character hexadecimal hash identifying the task (e.g., "a3f2b891")

**Examples:**
- `claude-step-my-refactor-a3f2b891`
- `claude-step-auth-migration-f7c4d3e2`
- `claude-step-swift-migration-39b1209d`

## Implementation

### Formatting Branch Names

Branch names are created using `PRService.format_branch_name()`:

```python
from claudestep.services.core.pr_service import PRService

# Format branch name with project and task hash
branch_name = PRService.format_branch_name("my-refactor", "a3f2b891")
# Result: "claude-step-my-refactor-a3f2b891"
```

### Parsing Branch Names

Branch names can be parsed to extract project and task information:

```python
from claudestep.services.core.pr_service import PRService

# Parse branch name
result = PRService.parse_branch_name("claude-step-my-refactor-a3f2b891")
# Returns: ('my-refactor', 'a3f2b891', 'hash')

if result:
    project_name, task_identifier, format_version = result
    print(f"Project: {project_name}")
    print(f"Task: {task_identifier}")
    print(f"Format: {format_version}")
```

The parser returns a tuple containing:
1. **Project name** (str): The project name extracted from the branch
2. **Task identifier** (str): The task hash
3. **Format version** (str): The format type - "hash" for current format

Returns `None` if the branch doesn't match the ClaudeStep naming pattern.

## Format Detection Logic

The `parse_branch_name()` method uses pattern matching to identify valid ClaudeStep branches:

**Pattern:** `^claude-step-(.+)-([a-z0-9]+)$`

**Hash Format Detection:**
- Task identifier must be exactly 8 characters
- All characters must be hexadecimal (0-9, a-f)
- Lowercase only

**Example validation:**
```python
# Valid hash format (8 hex chars)
"a3f2b891"  # ✅ Valid
"f7c4d3e2"  # ✅ Valid

# Invalid formats
"a3f2b89"   # ❌ Only 7 chars
"g3f2b891"  # ❌ Contains 'g' (not hex)
"A3F2B891"  # ❌ Uppercase (hash should be lowercase)
```

## Integration with Task Hashing

Branch names use the same hash generated by the task identification system (see [Hash-Based Task Identification](hash-based-task-identification.md)):

1. **Task hash is generated** from task description using SHA-256
2. **First 8 characters** of hex digest are used as task identifier
3. **Branch name is created** combining project name and task hash
4. **PRs are tracked** by this stable identifier

This creates a direct link between:
- Task in spec.md → Task hash → Branch name → Pull request

## Project Name Handling

**Project names can contain hyphens**, which is why the pattern uses greedy matching:

```python
# Valid project names
"my-refactor"          # ✅ Single hyphen
"auth-api-migration"   # ✅ Multiple hyphens
"swift-migration"      # ✅ Single hyphen

# Branch parsing handles this correctly
"claude-step-auth-api-migration-a3f2b891"
# Parses as: project="auth-api-migration", hash="a3f2b891"
```

The regex pattern `(.+)` matches greedily up to the last hyphen before the task hash, ensuring project names with hyphens are correctly extracted.

## Usage in Codebase

### Command: prepare.py

The `prepare` command creates branch names when staging new PRs:

```python
# In cli/commands/prepare.py
branch_name = pr_service.format_branch_name(detected_project, task_hash)
subprocess.run(["git", "checkout", "-b", branch_name])
```

### Service: PRService

The `PRService` provides branch naming utilities:

```python
# src/claudestep/services/core/pr_service.py

class PRService:
    @staticmethod
    def format_branch_name(project_name: str, task_hash: str) -> str:
        """Format branch name using hash-based identification."""
        return f"claude-step-{project_name}-{task_hash}"

    @staticmethod
    def parse_branch_name(branch: str) -> Optional[Tuple[str, str, str]]:
        """Parse branch and detect format."""
        # Returns (project_name, task_hash, "hash") or None
```

### Domain: GitHubPullRequest

The `GitHubPullRequest` model uses branch parsing to extract metadata:

```python
# src/claudestep/domain/github_models.py

@property
def project_name(self) -> Optional[str]:
    """Extract project name from branch."""
    parsed = PRService.parse_branch_name(self.head_ref_name)
    return parsed[0] if parsed else None

@property
def task_hash(self) -> Optional[str]:
    """Extract task hash from branch."""
    parsed = PRService.parse_branch_name(self.head_ref_name)
    if parsed and parsed[2] == "hash":
        return parsed[1]
    return None
```

## Benefits

1. **Stable Identification**: Task hash never changes even if task is reordered
2. **Project Isolation**: Project name in branch prevents naming conflicts
3. **Easy Filtering**: PRs can be filtered by project using branch name patterns
4. **Human Readable**: Branch names clearly show project and task identifier
5. **Parse-able**: Structured format enables programmatic extraction of metadata

## Related Documentation

- [Hash-Based Task Identification](hash-based-task-identification.md) - How task hashes are generated
- `src/claudestep/services/core/pr_service.py` - Branch naming implementation
- `src/claudestep/domain/github_models.py` - PR model integration
