# PR Summary Comment Feature - Implementation Plan

## Overview

Add an optional feature to post AI-generated summary comments on PRs created by ClaudeStep. The summary will analyze the PR diff and workflow context, explaining what was done and why in <200 words.

## Architecture Decision

**Approach**: Add a new workflow step that invokes `anthropics/claude-code-action@v1` again with a prompt to analyze the PR diff and post a summary comment.

**Why**:
- Reuses the same claude-code-action we already use for the main refactoring
- No need for new Python modules or API client code
- Claude Code can fetch the diff, analyze it, and post the comment all in one step
- Consistent with existing workflow pattern
- Simpler implementation

---

## Implementation Checklist

### Phase 1: Prepare Summary Prompt ✅ COMPLETED

- [x] **Create Prompt Template** (`scripts/claudestep/prompts/summary_prompt.md`)

  Create a prompt template file that will be used for the summary generation:

  ```markdown
  You are analyzing a pull request that was just created by ClaudeStep.

  ## Context
  - Task completed: {TASK_DESCRIPTION}
  - PR number: {PR_NUMBER}
  - Workflow run: {WORKFLOW_URL}

  ## Your Task

  1. Fetch the PR diff using: `gh pr diff {PR_NUMBER} --patch`
  2. Analyze the changes made in the diff
  3. Generate a concise summary (<200 words) that explains:
     - What specific changes were made (files, functions, logic)
     - Why these changes were made (purpose, benefits)
     - Any notable implementation details

  4. Post the summary as a comment on the PR using:
     ```bash
     gh pr comment {PR_NUMBER} --body-file <temp_file>
     ```

  Format the comment as:
  ```markdown
  ## AI-Generated Summary

  [Your summary here - be specific about what was changed and why]

  ---
  *Generated by ClaudeStep • [View workflow run]({WORKFLOW_URL})*
  ```

  Use clear, technical language. Be specific about files and functions modified.
  ```

- [x] **Create Helper Script** (`scripts/claudestep/commands/prepare_summary.py`)

  Create a simple script to generate the summary prompt:

  - Function: `cmd_prepare_summary(args, gh)`
  - Read environment variables: `PR_NUMBER`, `TASK`, `GITHUB_REPOSITORY`, `GITHUB_RUN_ID`
  - Load prompt template from `prompts/summary_prompt.md`
  - Substitute variables: `{TASK_DESCRIPTION}`, `{PR_NUMBER}`, `{WORKFLOW_URL}`
  - Write final prompt to `$GITHUB_OUTPUT` as `summary_prompt`
  - Simple string substitution, no API calls needed

- [x] **Register Command in Dispatcher** (`scripts/claudestep/__main__.py`)

  Wire up the new command:

  - Import: `from claudestep.commands.prepare_summary import cmd_prepare_summary`
  - Add parser: `parser_prepare_summary = subparsers.add_parser("prepare-summary", help="...")`
  - Add routing: `elif args.command == "prepare-summary": return cmd_prepare_summary(args, gh)`

---

### Phase 2: GitHub Actions Integration ✅ COMPLETED

- [x] **Add Optional Input Flag** (`action.yml`)

  Add new input parameter (around line 47):

  ```yaml
  add_pr_summary:
    description: 'Add AI-generated summary comment to PR (true/false)'
    required: false
    default: 'true'
  ```

  Default to `'true'` to enable feature by default (users can opt-out).

- [x] **Add Workflow Steps** (`action.yml`)

  Add two new steps after finalize, before artifact upload (around line 142):

  **Step 1: Prepare summary prompt**
  ```yaml
  - name: Prepare summary prompt
    id: prepare_summary
    if: |
      inputs.add_pr_summary == 'true' &&
      steps.finalize.outputs.pr_number != ''
    shell: bash
    working-directory: ${{ inputs.working_directory }}
    env:
      GH_TOKEN: ${{ inputs.github_token }}
      PR_NUMBER: ${{ steps.finalize.outputs.pr_number }}
      TASK: ${{ steps.prepare.outputs.task }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      GITHUB_RUN_ID: ${{ github.run_id }}
      ACTION_PATH: ${{ github.action_path }}
    run: |
      export PYTHONPATH="$ACTION_PATH/scripts:$PYTHONPATH"
      python3 -m claudestep prepare-summary
  ```

  **Step 2: Generate and post summary using Claude Code**
  ```yaml
  - name: Generate and post PR summary
    if: |
      inputs.add_pr_summary == 'true' &&
      steps.prepare_summary.outputs.summary_prompt != ''
    uses: anthropics/claude-code-action@v1
    with:
      prompt: ${{ steps.prepare_summary.outputs.summary_prompt }}
      anthropic_api_key: ${{ inputs.anthropic_api_key }}
      github_token: ${{ inputs.github_token }}
      claude_args: '--allowedTools Bash'
      show_full_output: true
    continue-on-error: true
  ```

  Key features:
  - Two-step process: prepare prompt, then run Claude Code
  - Reuses existing claude-code-action pattern
  - Only allows Bash tool (for gh commands)
  - Uses `continue-on-error: true` to prevent workflow failure on error
  - All context embedded in the prompt

---

### Phase 3: Documentation

- [ ] **Update README.md**

  Add documentation:

  - In "Quick Start" section: Mention PR summary feature
  - In "Action Inputs" section: Document `add_pr_summary` input
  - Add example showing how to disable: `add_pr_summary: false`
  - Note about API costs (~$0.002-0.005 per summary)
  - Explain what the summary includes (what was done + why)

- [ ] **Update Architecture Documentation** (`docs/architecture.md`)

  Add section explaining:

  - New prepare-summary command architecture
  - Why we reuse claude-code-action (consistency with main workflow)
  - Data flow: finalize → prepare-summary → claude-code-action → PR comment
  - Error handling strategy (graceful degradation)

---

### Phase 4: Testing

- [ ] **Create Unit Tests** (`tests/test_prepare_summary.py`)

  Test cases:

  1. `test_prepare_summary_with_valid_inputs()` - Happy path with all inputs
  2. `test_prepare_summary_without_pr_number()` - Gracefully skips when no PR
  3. `test_prepare_summary_template_substitution()` - Variables correctly substituted
  4. `test_prepare_summary_output_format()` - Prompt format is correct

  Mocking strategy:
  - Mock template file reading
  - Use environment variable fixtures
  - Verify output variables

- [ ] **Integration Test in Demo Repo**

  Test plan using `/Users/bill/Developer/personal/claude-refactor-chain`:

  1. Create test refactor project with simple spec.md
  2. Add test workflow that uses the action
  3. Run workflow manually with `add_pr_summary: true`
  4. Verify PR is created
  5. Verify summary comment appears on PR
  6. Check summary is <200 words
  7. Check summary mentions specific changes
  8. Re-run with `add_pr_summary: false` and verify no comment

- [ ] **Manual Testing Checklist**

  Test scenarios:

  - [ ] Happy path: Summary posted successfully
  - [ ] Summary mentions specific file/function changes
  - [ ] Summary explains why changes were made
  - [ ] Summary is <200 words
  - [ ] Feature can be disabled with `add_pr_summary: false`
  - [ ] Large diffs (>50k chars) are truncated with notice
  - [ ] Invalid API key shows warning, doesn't fail workflow
  - [ ] GitHub CLI failure shows warning, doesn't fail workflow
  - [ ] No PR created (finalize skip) → step skipped gracefully
  - [ ] Workflow run link in comment is clickable and correct

---

## Implementation Order

Execute in this sequence:

1. Phase 1.1: Create `prompts/summary_prompt.md` (NEW file)
2. Phase 1.2: Create `commands/prepare_summary.py` (NEW file)
3. Phase 1.3: Register command in `__main__.py` (EDIT)
4. Phase 2.1: Add input flag to `action.yml` (EDIT)
5. Phase 2.2: Add workflow steps to `action.yml` (EDIT)
6. Phase 4: Write and run tests
7. Phase 3: Update documentation

---

## Key Files Reference

| File | Action | Purpose |
|------|--------|---------|
| `action.yml` | Edit | Add input flag and workflow steps |
| `scripts/claudestep/prompts/summary_prompt.md` | Create | Prompt template for summary generation |
| `scripts/claudestep/commands/prepare_summary.py` | Create | Generate summary prompt with context |
| `scripts/claudestep/__main__.py` | Edit | Register prepare-summary command |
| `tests/test_prepare_summary.py` | Create | Unit tests for prepare_summary command |
| `README.md` | Edit | Document new feature |
| `docs/architecture.md` | Edit | Add architecture documentation |

---

## Technical Details

### Data Flow

```
1. Finalize step completes → Outputs pr_number
2. Prepare summary step starts (if enabled and PR exists)
   - Load prompt template from prompts/summary_prompt.md
   - Substitute: {TASK_DESCRIPTION}, {PR_NUMBER}, {WORKFLOW_URL}
   - Output: summary_prompt
3. Claude Code step starts (receives summary_prompt)
   - Claude reads the prompt with context
   - Runs: gh pr diff <pr_number> --patch
   - Analyzes the diff
   - Generates summary (<200 words)
   - Posts comment: gh pr comment <pr_number> --body-file <temp>
4. Summary appears on PR
```

### Error Handling Strategy

**Graceful Degradation**:
- PR creation already succeeded; summary is nice-to-have
- Both workflow steps have `continue-on-error: true`
- If prepare-summary fails: summary step skipped
- If Claude Code fails: workflow continues anyway
- User can retry manually if needed

### Diff Size

- No explicit truncation needed
- Claude Code handles large diffs automatically
- Claude will work with whatever the PR diff is
- If diff is very large, summary may focus on key changes

### API Costs

- Input tokens: ~500-5000 (depends on diff size)
- Output tokens: ~500 (200 words max)
- Cost per summary: ~$0.002-0.005 (Sonnet 4.5)
- Users control via `add_pr_summary` flag

---

## Trade-offs & Limitations

### Trade-offs Made

1. **Default enabled** - Feature on by default provides immediate value, but uses API credits
   - Mitigation: Users can easily disable

2. **Reuse claude-code-action** - Use same action for both refactoring and summary
   - Rationale: Consistent pattern, simpler implementation, no new dependencies
   - Trade-off: Slightly more overhead than direct API call (but negligible)

3. **Continue on error** - Don't fail workflow if summary fails
   - Rationale: PR creation is the critical operation
   - Trade-off: May silently skip summaries on error

4. **Two-step process** - Separate prompt preparation from Claude Code execution
   - Rationale: Keeps prompt template readable and maintainable
   - Trade-off: One extra workflow step

5. **Template-based prompts** - Use markdown template file for prompt
   - Rationale: Easy to read, edit, and version control
   - Trade-off: Requires template file management

### Known Limitations

1. **Large PRs**: Very large diffs may be harder for Claude to summarize completely
2. **API costs**: Each summary costs ~$0.002-0.005 (can add up with many PRs)
3. **Workflow logs**: Doesn't analyze the main Claude Code execution logs (could be added in v2)
4. **Summary quality**: Depends on diff clarity and task description quality
5. **Timing**: Posted immediately after PR creation (can't wait for workflow completion)
6. **Overhead**: Runs full claude-code-action just for a comment (but minimal impact)

---

## Success Criteria

✅ PR summary comments posted automatically after PR creation
✅ Summaries are <200 words and explain what was done + why
✅ Summaries mention specific files/functions changed
✅ Feature can be toggled on/off via `add_pr_summary` input
✅ Errors don't fail the workflow (graceful degradation)
✅ Works with demo repo for real-world testing
✅ Unit tests pass with good coverage
✅ Documentation updated (README + architecture docs)

---

## Implementation Notes

### Phase 1 Completion (2025-12-26)

**Files Created:**
- `scripts/claudestep/prompts/summary_prompt.md` - Prompt template for Claude Code to generate PR summaries
- `scripts/claudestep/commands/prepare_summary.py` - Command handler for preparing summary prompts

**Files Modified:**
- `scripts/claudestep/__main__.py` - Registered `prepare-summary` command in CLI dispatcher

**Testing Results:**
- ✅ CLI command works correctly with valid inputs (PR_NUMBER, TASK, GITHUB_REPOSITORY, GITHUB_RUN_ID)
- ✅ Gracefully skips when PR_NUMBER is empty (outputs notice, exits with code 0)
- ✅ Properly substitutes template variables ({TASK_DESCRIPTION}, {PR_NUMBER}, {WORKFLOW_URL})
- ✅ Output format is correct (summary_prompt contains full prompt text)
- ✅ Python compilation successful for all new files
- ✅ Help text displays new command correctly

**Technical Implementation Details:**
1. **Prompt Template**: Simple markdown template stored in `prompts/summary_prompt.md`. Uses placeholder syntax `{VARIABLE_NAME}` for string substitution.

2. **Command Handler**: `cmd_prepare_summary()` function follows same pattern as other commands (prepare, finalize):
   - Takes `args` (argparse.Namespace) and `gh` (GitHubActionsHelper) parameters
   - Returns integer exit code (0 = success, 1 = error)
   - Gracefully handles missing PR_NUMBER (returns 0, not an error)
   - Uses `gh.write_output()` to set GITHUB_OUTPUT variable

3. **Variable Substitution**: Simple string replacement using `.replace()`:
   - `{TASK_DESCRIPTION}` → Value of `TASK` env var
   - `{PR_NUMBER}` → Value of `PR_NUMBER` env var
   - `{WORKFLOW_URL}` → Constructed from `GITHUB_REPOSITORY` and `GITHUB_RUN_ID`

4. **Error Handling**:
   - Missing PR_NUMBER: Outputs notice and skips (exit 0)
   - Missing TASK/REPO/RUN_ID: Outputs error and fails (exit 1)
   - Template file not found: Outputs error and fails (exit 1)
   - All exceptions caught and reported via GitHub Actions error annotations

**Next Steps:**
- ~~Phase 2: Add GitHub Actions workflow integration (action.yml modifications)~~ ✅ COMPLETED
- Phase 3: Update documentation (README.md, architecture.md)
- Phase 4: Write unit tests and perform integration testing

---

### Phase 2 Completion (2025-12-26)

**Files Modified:**
- `action.yml` - Added `add_pr_summary` input and two new workflow steps

**Testing Results:**
- ✅ Python syntax validation passed for all files
- ✅ CLI command `prepare-summary` works with valid inputs (PR_NUMBER, TASK, GITHUB_REPOSITORY, GITHUB_RUN_ID, ACTION_PATH)
- ✅ Gracefully skips when PR_NUMBER is empty (outputs notice, exits with code 0)
- ✅ Template substitution verified ({TASK_DESCRIPTION}, {PR_NUMBER}, {WORKFLOW_URL})
- ✅ Output format correct (summary_prompt contains 960 character prompt)
- ✅ Help text displays command correctly

**Technical Implementation Details:**

1. **Input Parameter**: Added `add_pr_summary` input to action.yml at line 48:
   - Description: 'Add AI-generated summary comment to PR (true/false)'
   - Default: 'true' (feature enabled by default, users can opt-out)
   - Required: false

2. **Workflow Step 1 - Prepare summary prompt** (lines 146-162):
   - ID: `prepare_summary`
   - Conditional: Only runs if `add_pr_summary == 'true'` AND `pr_number != ''`
   - Sets environment variables: GH_TOKEN, PR_NUMBER, TASK, GITHUB_REPOSITORY, GITHUB_RUN_ID, ACTION_PATH
   - Executes: `python3 -m claudestep prepare-summary`
   - Outputs: `summary_prompt` (full prompt text with substituted variables)

3. **Workflow Step 2 - Generate and post PR summary** (lines 164-175):
   - Conditional: Only runs if `add_pr_summary == 'true'` AND `summary_prompt != ''`
   - Uses: `anthropics/claude-code-action@v1`
   - Prompt: From `prepare_summary.outputs.summary_prompt`
   - Allowed tools: Only `Bash` (for gh CLI commands)
   - Error handling: `continue-on-error: true` (graceful degradation)

4. **Integration Points:**
   - Workflow step depends on `steps.finalize.outputs.pr_number` being set
   - Reuses task description from `steps.prepare.outputs.task`
   - Positioned after finalize, before artifact upload
   - No impact on main workflow if summary generation fails

5. **Error Handling:**
   - Missing PR_NUMBER: Step skipped gracefully (notice logged)
   - Missing required env vars: Error logged, step fails but workflow continues
   - Template file not found: Error logged, step fails but workflow continues
   - Claude Code failure: Workflow continues due to `continue-on-error: true`

**Next Steps:**
- Phase 3: Update documentation (README.md, architecture.md)
- Phase 4: Write unit tests and perform integration testing
