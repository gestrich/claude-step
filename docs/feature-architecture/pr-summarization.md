# PR Summarization Feature

## Overview

ClaudeChain includes an optional feature to automatically post AI-generated summary comments on PRs. The summary analyzes the PR diff and workflow context, explaining what was done and why in under 200 words.

## Architecture Decision

**Approach**: The feature adds a new workflow step that invokes `anthropics/claude-code-action@v1` with a prompt to analyze the PR diff and post a summary comment.

**Rationale**:
- Reuses the same claude-code-action already used for main refactoring
- No need for new Python modules or API client code
- Claude Code can fetch the diff, analyze it, and post the comment all in one step
- Consistent with existing workflow pattern
- Simpler implementation

## Technical Design

### Data Flow

```
1. Finalize step completes → Outputs pr_number
2. Prepare summary step starts (if enabled and PR exists)
   - Load prompt template from resources/prompts/summary_prompt.md
   - Substitute: {TASK_DESCRIPTION}, {PR_NUMBER}, {WORKFLOW_URL}
   - Output: summary_prompt
3. Claude Code step starts (receives summary_prompt)
   - Claude reads the prompt with context
   - Runs: gh pr diff <pr_number> --patch
   - Analyzes the diff
   - Generates summary (<200 words)
   - Posts comment: gh pr comment <pr_number> --body-file <temp>
4. Summary appears on PR
```

### Components

#### 1. Prompt Template
- Location: `src/claudechain/resources/prompts/summary_prompt.md`
- Purpose: Template for summary generation with variable substitution
- Variables: `{TASK_DESCRIPTION}`, `{PR_NUMBER}`, `{WORKFLOW_URL}`

#### 2. Prepare Summary Command
- Module: `src/claudechain/cli/commands/prepare_summary.py`
- Function: `cmd_prepare_summary(args, gh)`
- Reads environment variables: `PR_NUMBER`, `TASK`, `GITHUB_REPOSITORY`, `GITHUB_RUN_ID`
- Performs template variable substitution
- Writes final prompt to `$GITHUB_OUTPUT` as `summary_prompt`

#### 3. GitHub Actions Integration
- Input flag: `add_pr_summary` (default: `true`)
- Two workflow steps in `action.yml`:
  1. **Prepare summary prompt** - Generates prompt with context
  2. **Generate and post PR summary** - Runs claude-code-action with prompt

### Summary Comment Format

```markdown
## AI-Generated Summary

[Detailed summary of changes - specific about files and functions modified]

---
*Generated by ClaudeChain • [View workflow run]({WORKFLOW_URL})*
```

## Error Handling

**Graceful Degradation Strategy**:
- PR creation already succeeded; summary is nice-to-have
- Both workflow steps have `continue-on-error: true`
- If prepare-summary fails: summary step skipped
- If Claude Code fails: workflow continues anyway
- User can retry manually if needed

**Error Scenarios**:
- **Missing PR_NUMBER**: Step gracefully skips (notice logged, exit 0)
- **Missing required env vars**: Error logged, step fails but workflow continues
- **Template file not found**: Error logged, step fails but workflow continues
- **Claude Code failure**: Workflow continues due to `continue-on-error: true`

## API Costs

- Input tokens: ~500-5000 (depends on diff size)
- Output tokens: ~500 (200 words max)
- Cost per summary: ~$0.002-0.005 (Sonnet 4.5)
- Users control via `add_pr_summary` flag (default enabled)

## Trade-offs

### Design Decisions

1. **Default enabled** - Provides immediate value but uses API credits
   - Mitigation: Users can easily disable with `add_pr_summary: false`

2. **Reuse claude-code-action** - Use same action for both refactoring and summary
   - Rationale: Consistent pattern, simpler implementation, no new dependencies
   - Trade-off: Slightly more overhead than direct API call (negligible)

3. **Continue on error** - Don't fail workflow if summary fails
   - Rationale: PR creation is the critical operation
   - Trade-off: May silently skip summaries on error

4. **Two-step process** - Separate prompt preparation from Claude Code execution
   - Rationale: Keeps prompt template readable and maintainable
   - Trade-off: One extra workflow step

5. **Template-based prompts** - Use markdown template file for prompt
   - Rationale: Easy to read, edit, and version control
   - Trade-off: Requires template file management

### Known Limitations

1. **Large PRs**: Very large diffs may be harder for Claude to summarize completely
2. **API costs**: Each summary costs ~$0.002-0.005 (can add up with many PRs)
3. **Workflow logs**: Doesn't analyze the main Claude Code execution logs
4. **Summary quality**: Depends on diff clarity and task description quality
5. **Timing**: Posted immediately after PR creation (can't wait for workflow completion)

## Configuration

Users can control the feature via the `add_pr_summary` input in their workflow file:

```yaml
- uses: anthropics/claude-chain@v1
  with:
    add_pr_summary: 'false'  # Disable PR summaries
```

## Key Files

| File | Purpose |
|------|---------|
| `action.yml` | Workflow steps and input flag |
| `src/claudechain/resources/prompts/summary_prompt.md` | Prompt template |
| `src/claudechain/cli/commands/prepare_summary.py` | Generate summary prompt with context |
| `tests/unit/cli/commands/test_prepare_summary.py` | Unit tests |
