# Enhanced Statistics Report with Task-PR Mapping

## Background

The current `StatisticsReport` shows aggregate counts (total tasks, completed, in-progress, pending) but lacks detail about individual tasks and their associated PRs. This makes it difficult to:

1. See which specific tasks have been completed and which PRs completed them
2. Identify "orphaned" PRs - those that were merged/opened but whose corresponding task was removed from spec.md
3. Track the relationship between spec tasks and GitHub PRs

The user wants the statistics report (in both GitHub workflow summaries and Slack messages) to show:
- Each task from the spec with its status and associated PR (if any)
- Orphaned PRs that no longer have corresponding spec tasks

The key insight is that `StatisticsReport` should be the **single source of truth** for all reporting data, initialized with the detailed task/PR mappings needed for any output format.

## Phases

- [x] Phase 1: Extend Domain Models for Task-PR Mapping

Add new domain models and extend `ProjectStats` to hold detailed task-PR relationships:

**New models to add to `src/claudestep/domain/models.py`:**
- `TaskStatus` - Enum for task states: PENDING, IN_PROGRESS, COMPLETED
- `TaskWithPR` - A task from spec.md linked to its associated PR (if any):
  - `task_hash: str` - Hash from spec task
  - `description: str` - Task description
  - `status: TaskStatus`
  - `pr: Optional[GitHubPullRequest]` - Associated PR if any

**Extend `ProjectStats`:**
- Add `tasks: List[TaskWithPR]` - All tasks with their PR associations
- Add `orphaned_prs: List[GitHubPullRequest]` - PRs with no matching spec task

The `task_hash` from `SpecTask` is already computed - we need to match it against PR branch names which contain the hash (e.g., `claude-step-project-name-a1b2c3d4`).

- [x] Phase 2: Update Statistics Service to Collect Task-PR Mappings

Modify `StatisticsService.collect_project_stats()` to:

1. Parse spec.md to get all tasks with their hashes
2. Fetch all PRs (open and merged) for the project
3. For each PR, extract the task hash from the branch name pattern `claude-step-{project}-{hash}`
4. Match PRs to tasks by hash:
   - If task exists in spec and has matching PR: create `TaskWithPR` with status based on PR state
   - If task exists in spec with no PR: create `TaskWithPR` with PENDING status
   - If PR has no matching task in spec: add to `orphaned_prs`

**Key files to modify:**
- `src/claudestep/services/composite/statistics_service.py`
- May need to add method to `PRService` to fetch merged PRs for a project (currently only fetches open PRs)

- [x] Phase 3: Add Merged PRs Fetching to PRService

Currently `PRService.get_open_prs_for_project()` only returns open PRs. We need to also fetch merged PRs to:
- Count how many tasks are completed
- Identify orphaned merged PRs

Add new method to `src/claudestep/services/core/pr_service.py`:
- `get_merged_prs_for_project(project_name: str, label: str, days_back: int) -> List[GitHubPullRequest]`

This will use the GitHub API to fetch recently merged PRs with the claudestep label for the project.

- [x] Phase 4: Update Report Formatting for Detailed Task View

Added `format_project_details(for_slack: bool = False) -> str` method to `StatisticsReport` in `src/claudestep/domain/models.py`.

Output format:
```
## print-line-count (5/20 complete)

### Tasks
- [x] `echo "Hello World!"` - PR #31 (Merged)
- [ ] `echo "Hello World!!"` - PR #32 (Open, 2d)
- [ ] `echo "Hello World!!!"` - (no PR)
...

### Orphaned PRs
- PR #25 (Merged) - Task removed from spec
- PR #28 (Open, 5d) - Task removed from spec
```

**TODO:** Update GitHub Step Summary in `statistics.py` CLI command to include this detailed view.

- [ ] Phase 5: Update Slack Report Format

Consider whether Slack output should include the detailed task view. Options:
1. Include condensed version in Slack (just orphaned PRs warning)
2. Full detail in Slack (may be too verbose)
3. Only include in GitHub Step Summary

Initial approach: Add orphaned PRs to the warnings section in Slack, but keep the full task list only in GitHub Step Summary (as it supports longer content).

**Additionally:** Update the Slack message footer in `statistics/action.yml`:
- Change from: `"Generated by <...|ClaudeStep Statistics>"`
- Change to: `"See details in <...|ClaudeStep Statistics>"`

This better reflects that the Slack message is a summary pointing users to the full details in the GitHub Step Summary.

- [ ] Phase 6: Validation

**Unit Tests (DONE):**
- [x] Test `TaskWithPR` model creation and status determination
- [x] Test task-PR matching logic (by hash) - `TestTaskPRMappings` class (7 tests)
- [x] Test orphaned PR detection
- [x] Test formatting of detailed task view - `TestFormatProjectDetails` class (7 tests)

**Integration Tests:**
- Run statistics against swift-lambda-sample to verify:
  - Tasks are correctly matched to PRs
  - The orphaned PR (from removed spec task) is detected
  - Output format is readable

**Manual Verification:**
- Trigger statistics workflow on swift-lambda-sample
- Verify GitHub Step Summary shows detailed task list
- Verify orphaned PRs are identified

Run: `python3 -m pytest tests/unit/services/composite/test_statistics_service.py -v`
